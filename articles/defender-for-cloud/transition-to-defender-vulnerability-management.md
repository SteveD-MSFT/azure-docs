---
title: Transition to Microsoft Defender Vulnerability Management
description: Learn how to transition to Microsoft Defender Vulnerability Management in Microsoft Defender for Cloud.
ms.topic: how-to
ms.date: 01/08/2024
---

# Transition to Microsoft Defender Vulnerability Management

Microsoft Defender for Cloud is unifying all vulnerability assessment solutions to utilize the Microsoft Defender Vulnerability Management vulnerability scanner.

Microsoft Defender Vulnerability Management integrates across many cloud native use cases, such as containers ship and runtime scenarios. As part of this change, we're retiring our built-in vulnerability assessments offering powered by Qualys.

> [!IMPORTANT]
> The Defender for Cloud Containers Vulnerability Assessment powered by Qualys is now on a retirement path completing on **March 1st, 2024**.
>
> Customers that onboarded at least one subscription to Defender for Containers prior to **November 15th, 2023** can continue to use Container Vulnerability Assessment powered by Qualys until **March 1st, 2024**.
>
> For more information about the change, see [Defender for Cloud unifies Vulnerability Assessment solution powered by Microsoft Defender Vulnerability Management](https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/defender-for-cloud-unified-vulnerability-assessment-powered-by/ba-p/3990112).

If you're currently using the built vulnerability assessment solution powered by Qualys, start planning for the upcoming retirement by following the steps on this page.

## Step 1: Verify that scanning is enabled

Container vulnerability assessment scanning powered by Microsoft Defender Vulnerability Management is enabled by default for Defender for Containers, Defender for Container Registries (deprecated) and Defender Cloud Security Posture Management. Organizations that disabled it need to re-enable the **Agentless container vulnerability assessment** toggle in one of the plans. It reflects automatically to any of the mentioned plans enabled.

:::image type="content" source="media/transition-to-defender-vulnerability-management/enable-agentless-container-vulnerability-assessment.png" alt-text="Screenshot of enabling “Agentless container vulnerability assessment” in settings." lightbox="media/transition-to-defender-vulnerability-management/enable-agentless-container-vulnerability-assessment.png":::

For more information on enabling Microsoft Defender Vulnerability Management scanning, see [Enable vulnerability assessment powered by Microsoft Defender Vulnerability Management](enable-vulnerability-assessment.md).

## Step 2: Disable Qualys recommendations

If your organization is ready to transition to container vulnerability assessment scanning powered by Microsoft Defender Vulnerability Management and no longer receive results from the Qualys recommendations, you can go ahead and disable the recommendations reporting on Qualys scanning results. Following are the recommendation names and assessment keys referenced throughout this guide.

### Qualys recommendations and assessment Keys

| Recommendation | Description | Assessment Key
|--|--|--|
| [Azure registry container images should have vulnerability findings resolved (powered by Qualys)](https://ms.portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/ContainerRegistryRecommendationDetailsBlade/assessmentKey/dbd0cb49-b563-45e7-9724-889e799fa648)| Container image vulnerability assessment scans your registry for security vulnerabilities and exposes detailed findings for each image. Resolving the vulnerabilities can greatly improve your containers' security posture and protect them from attacks. | dbd0cb49-b563-45e7-9724-889e799fa648 |
| [Azure running container images should have vulnerability findings resolved (powered by Qualys)](https://ms.portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/KubernetesRuntimeVisibilityRecommendationDetailsBlade/assessmentKey/41503391-efa5-47ee-9282-4eff6131462c) | Container image vulnerability assessment scans container images running on your Kubernetes clusters for security vulnerabilities and exposes detailed findings for each image. Resolving the vulnerabilities can greatly improve your containers' security posture and protect them from attacks. | 41503391-efa5-47ee-9282-4eff6131462c |

### Microsoft Defender Vulnerability Management recommendations and assessment keys

| Recommendation | Description | Assessment Key
|--|--|--|
| [Azure registry container images should have vulnerability findings resolved (powered by Microsoft Defender Vulnerability Management)-Preview](https://ms.portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/AzureContainerRegistryRecommendationDetailsBlade/assessmentKey/c0b7cfc6-3172-465a-b378-53c7ff2cc0d5) | Container image vulnerability assessment scans your registry for commonly known vulnerabilities (CVEs) and provides a detailed vulnerability report for each image. Resolving vulnerabilities can greatly improve your security posture, ensuring images are safe to use prior to deployment. | c0b7cfc6-3172-465a-b378-53c7ff2cc0d5 |
| [Azure running container images should have vulnerability findings resolved (powered by Microsoft Defender Vulnerability Management)](https://ms.portal.azure.com/#view/Microsoft_Azure_Security_CloudNativeCompute/ContainersRuntimeRecommendationDetailsBlade/assessmentKey/c609cf0f-71ab-41e9-a3c6-9a1f7fe1b8d5)  | Container image vulnerability assessment scans your registry for commonly known vulnerabilities (CVEs) and provides a detailed vulnerability report for each image. This recommendation provides visibility to vulnerable images currently running in your Kubernetes clusters. Remediating vulnerabilities in container images that are currently running is key to improving your security posture, significantly reducing the attack surface for your containerized workloads. | c609cf0f-71ab-41e9-a3c6-9a1f7fe1b8d5 |

### Disable using the Qualys recommendations for Azure commercial clouds

To disable the above Qualys recommendations for Azure commercial clouds using the Defender for Cloud UI:

1. In the Azure portal, navigate to Defender for Cloud and open the **Recommendations** page.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/select-recommendations.png" alt-text="Screenshot showing Recommendations selection.":::

1. Search for one of the Qualys recommendations.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/powered-by-qualys.png" alt-text="Screenshot showing Search for one of the Qualys recommendations." lightbox="media/transition-to-defender-vulnerability-management/powered-by-qualys.png":::

1. Choose the recommendation and select **"Exempt"**.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/powered-by-qualys-select-exempt.png" alt-text="Screenshot showing how to select Exempt.":::

1. Select the management group or subscriptions where you want to exempt the Qualys recommendation.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/powered-by-qualys-exempt.png" alt-text="Screenshot showing the selection of the management group or subscriptions to exempt.":::

1. Fill out the remaining details and select create. Wait up to 30 minutes for the exemptions to take effect.

### Disable using the Qualys recommendations for national clouds

To disable the above Qualys recommendations for national clouds (Azure Government and Azure operated by 21Vianet) using the Defender for Cloud UI:

1. Go to **Environment settings** and select the relevant subscription you want to disable the recommendation on.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/environment-settings.png" alt-text="Screenshot showing how to select subscription in environment settings." lightbox="media/transition-to-defender-vulnerability-management/environment-settings.png":::

1. In the **Settings** pane, go to **Security policy**, and select the initiative assignment.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/security-policy.png" alt-text="Screenshot of security policy settings." lightbox="media/transition-to-defender-vulnerability-management/security-policy.png":::

1. Search for the Qualys recommendation and select **Manage effect and parameters**.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/qualys-recommendation.png" alt-text="Screenshot of Qualys recommendation." lightbox="media/transition-to-defender-vulnerability-management/qualys-recommendation.png":::

1. Change to **Disabled**.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/select-disabled.png" alt-text="Screenshot of disable button." lightbox="media/transition-to-defender-vulnerability-management/select-disabled.png":::

## Step 3: (optional) Update REST API and Azure Resource Graph queries

If you're currently accessing container vulnerability assessment results powered by Qualys programmatically, either via the Azure Resource Graph (ARG) Rest API or Subassessment REST API or ARG queries, you need to update your existing queries to match the new schema and/or REST API provided by the new container vulnerability assessment powered by Microsoft Defender Vulnerability Management.

The next section includes a few examples that can help in understanding how existing queries for the Qualys powered offering should be translated to equivalent queries with the Microsoft Defender Vulnerability Management powered offering.

### ARG query examples

Any Azure Resource Graph queries used for reporting should be updated to reflect the Microsoft Defender Vulnerability Management assessmentKeys listed previously.  Following are examples to help you transition to Microsoft Defender Vulnerability Management queries.

#### Show unhealthy container images

##### **Qualys**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | where assessmentKey == "dbd0cb49-b563-45e7-9724-889e799fa648"
    | project 
        Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id)), 
        ResourceType = tolower(split(id,"/").[6]), 
        subscriptionId, 
        severity = properties.status.severity, 
        status = properties.status.code, 
        VulnId = properties.id, 
        description = properties.displayName, 
        patchable = properties.additionalData.patchable, 
        cve = properties.additionalData.cve, 
        Repo = properties.additionalData.repositoryName, 
        imageDigest = properties.additionalData.imageDigest
    | where status == 'Unhealthy' 
```

##### **Microsoft Defender Vulnerability Management**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | where assessmentKey == "c0b7cfc6-3172-465a-b378-53c7ff2cc0d5"
    | project 
        Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id)), 
        ResourceType = tolower(split(id,"/").[6]), 
        subscriptionId, 
        severity = properties.additionalData.vulnerabilityDetails.severity, 
        status = properties.status.code, 
        VulnId = properties.id, 
        description = properties.description, 
        fixStatus = properties.additionalData.softwareDetails.fixStatus, 
        Repo = properties.additionalData.artifactDetails.repositoryName, 
        imageUri = properties.resourceDetails.id
    | where status == 'Unhealthy' 
```

#### Show healthy container images

##### **Qualys**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | where assessmentKey == "dbd0cb49-b563-45e7-9724-889e799fa648"
    | project 
        Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id)), 
        ResourceType = tolower(split(id,"/").[6]), 
        subscriptionId, 
        status = properties.status.code, 
        Repo = properties.additionalData.repositoryName, 
        imageDigest = properties.additionalData.imageDigest
    | where status == 'Healthy'
```

##### **Microsoft Defender Vulnerability Management**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | where assessmentKey == "c0b7cfc6-3172-465a-b378-53c7ff2cc0d5"
    | project 
        Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id)), 
        ResourceType = tolower(split(id,"/").[6]), 
        subscriptionId, 
        status = properties.status.code,
        Repo = properties.additionalData.artifactDetails.repositoryName, 
        imageUri = properties.resourceDetails.id
    | where status == 'Healthy' 
```

#### Count vulnerable images by severity

##### **Qualys**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | extend status = tostring(parse_json(properties).status.code)
    | extend severity = tostring(parse_json(properties).status.severity)
    | extend vulId=tostring((properties).id)
    | extend Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id))
    | where assessmentKey == "dbd0cb49-b563-45e7-9724-889e799fa648"
    | where status == 'Unhealthy' 
    | distinct 
        vulId, 
        severity
    | summarize count=count() by tostring(severity)
```

##### **Microsoft Defender Vulnerability Management**

```kql
securityresources
    | where type == "microsoft.security/assessments/subassessments"
    | extend assessmentKey = extract(".*assessments/(.+?)/.*",1,  id)
    | extend severity = tostring(properties.additionalData.vulnerabilityDetails.severity)
    | extend status = tostring(parse_json(properties).status.code)
    | extend vulId=tostring((properties).id)
    | extend Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id))
    | where assessmentKey == "c0b7cfc6-3172-465a-b378-53c7ff2cc0d5"
    | where status == 'Unhealthy' 
    | distinct 
        vulId, 
        severity
    | summarize count=count() by tostring(severity)
```

#### View pod, container and namespace for a running vulnerable image on the AKS cluster

##### **Qualys**

```kql
securityresources 
| where type =~ "microsoft.security/assessments/subassessments"
| extend assessmentKey = extract(@"(?i)providers/Microsoft.Security/assessments/([^/]*)", 1, id),
         subAssessmentId = tostring(properties.id),
         parentResourceId = extract("(.+)/providers/Microsoft.Security", 1, id)
| extend resourceId = extract(@'(?i)(.*?)@([^/]+)', 1,tostring(properties.resourceDetails.id))
| extend severity = tostring(parse_json(properties).status.severity)
| extend VulnId = tostring(parse_json(properties).id)
| extend status = tostring(parse_json(properties).status.code)
| where assessmentKey == "41503391-efa5-47ee-9282-4eff6131462c"
| extend resourceId = tostring(properties.resourceDetails.id),
         parsedJson = parse_json(tostring(properties.additionalData))
| extend containerData = parse_json(tostring(parsedJson.data.Containers))
| mv-expand containerDetails = containerData to typeof(dynamic)
| extend ContainerName = tostring(containerDetails.Name),
         ContainerPod = tostring(containerDetails.Pod.Name),
         Namespace = tostring(containerDetails.Pod.Namespace),
         ControllerType = tostring(containerDetails.Pod.ControllerType),
         ControllerName = tostring(containerDetails.Pod.ControllerName)
| where status == 'Unhealthy'
|project Image=resourceId, VulnId,severity, Namespace, ContainerName, ContainerPod,ControllerName,ControllerType

```

##### **Microsoft Defender Vulnerability Management**

```kql
securityresources 
| where type =~ "microsoft.security/assessments/subassessments"
| extend assessmentKey=extract(@"(?i)providers/Microsoft.Security/assessments/([^/]*)", 1, id)
| where assessmentKey == "c609cf0f-71ab-41e9-a3c6-9a1f7fe1b8d5" 
| extend azureClusterId = tostring(properties.additionalData.clusterDetails.clusterResourceId)
| extend cve =tostring(properties.id)
| extend status = properties.status.code
| extend severity=tostring(parse_json(properties).additionalData.vulnerabilityDetails.severity)
| where status == "Unhealthy"
| extend azureImageId = tostring(properties.resourceDetails.id)
| extend severity = tolower(properties.additionalData.vulnerabilityDetails.severity)
| extend kubernetesContext = properties.additionalData.kubernetesContext
| mv-expand workload = kubernetesContext.workloads
| mv-expand OwnedResource = workload.ownedResources
| mv-expand OwnedContainer = OwnedResource.containers                    
| mv-expand Container = workload.containers                    
| extend isController = isnotempty(workload.ownedResources)
| extend namespace =  tostring(workload.namespace)
| extend podName = iff(isController, tostring(OwnedResource.name), workload.name)
| extend containerName = iff(isController, tostring(OwnedContainer.name), Container.name)
| extend controllerName =  iff(isController, tostring(workload.name),"") 
| extend controllerType =  iff(isController, tostring(workload.kind),"")                       
| extend imageName = extract("(.+)@sha256:", 1, azureImageId) 
| project imageName, cve, severity, clusterId = azureClusterId, containerName, podName, controllerName, controllerType, namespace

```

## Step 4: (optional) Container Security reporting

Microsoft Defender for Cloud provides out of the box reporting via Azure Workbooks, including a Container Security workbook.

:::image type="content" source="media/transition-to-defender-vulnerability-management/container-security-workbook.png" alt-text="Screenshot of Container Security workbook." lightbox="media/transition-to-defender-vulnerability-management/container-security-workbook.png":::

This workbook includes container vulnerability scanning results from both registry and runtime.

:::image type="content" source="media/transition-to-defender-vulnerability-management/workbook-vulnerability-assessment-results.png" alt-text="Screenshot of workbook including container vulnerability scanning results." lightbox="media/transition-to-defender-vulnerability-management/workbook-vulnerability-assessment-results.png":::

The workbook provides results from both Qualys and Microsoft Defender Vulnerability Management scanning, offering a comprehensive overview of vulnerabilities detected within your Azure Registry container images.  The Containers Security workbook provides the following benefits for container vulnerability assessment:

- **Dual Scanner Integration**: Users can easily compare results from both scanners in a single report while the Qualys results are still available. Filters also allow it to focus on results for a specific container registry or cluster.

- **Overview of all vulnerabilities**: View all vulnerabilities detected across your Azure Container Registries and running on the AKS cluster.

- **Exploitable vulnerabilities dashboard**: A dedicated section highlighting vulnerabilities with known exploits, enabling security teams to focus on vulnerabilities that pose a high risk of exploitation. This is only available with container vulnerability assessment scanning powered by Microsoft Defender Vulnerability Management.

    :::image type="content" source="media/transition-to-defender-vulnerability-management/exploitable-vulnerabilities-dashboard.png" alt-text="Screenshot of exploitable vulnerabilities dashboard." lightbox="media/transition-to-defender-vulnerability-management/exploitable-vulnerabilities-dashboard.png":::

- **Additional ARG queries**: You can use this workbook to view more examples of how to query ARG data between Qualys and Microsoft Defender Vulnerability Management. For more information on how to edit workbooks, see [Workbooks gallery in Microsoft Defender for Cloud]( custom-dashboards-azure-workbooks.md#workbooks-gallery-in-microsoft-defender-for-cloud).

## Next steps

- Learn more about [Vulnerability assessments for Azure with Microsoft Defender Vulnerability Management](agentless-container-registry-vulnerability-assessment.md).
- Check out [Common questions about the Microsoft Defender Vulnerability Management solution](common-questions-microsoft-defender-vulnerability-management.md).
